<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n de Referidos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { background-color: #111827; color: #d1d5db; }
        .table-auto th, .table-auto td { border-color: #374151; }
        .modal-content { max-height: 90vh; }
        .generated-code { white-space: pre-wrap; word-break: break-all; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-white mb-2">Panel de Administraci√≥n de Referidos</h1>
            <p class="text-lg text-gray-400">Genera QR y c√≥digo para nuevos referidos desde Google Sheets.</p>
        </header>

        <div class="mb-6 bg-gray-800 p-4 rounded-lg border border-gray-700">
            <label for="sheet-url" class="block text-sm font-medium text-white mb-2">URL del Google Sheet (publicado como CSV):</label>
            <div class="flex flex-col sm:flex-row gap-2">
                <input type="text" id="sheet-url" class="flex-grow bg-gray-700 border border-gray-600 text-white rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vS5pL2sLh4hZJ9zWJ_V8zY8x_6j2nQk_9tXo_8cZ7hY3jV-Q8wF6kOq_8dY9rXo-zWJ9dK/pub?output=csv">
                <button id="load-data-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Cargar Datos</button>
            </div>
        </div>
        
        <div id="loading" class="text-center my-4 hidden">Cargando datos...</div>
        <div id="error" class="text-center my-4 text-red-400 hidden"></div>
        
        <div class="overflow-x-auto bg-gray-800 rounded-lg border border-gray-700">
            <table id="referrals-table" class="table-auto w-full text-sm text-left">
                <thead class="bg-gray-700 text-xs uppercase">
                    <tr>
                        <th class="px-4 py-3">Timestamp</th>
                        <th class="px-4 py-3">Nombre / Comercio</th>
                        <th class="px-4 py-3">Especializaci√≥n</th>
                        <th class="px-4 py-3">Barrio</th>
                        <th class="px-4 py-3">WhatsApp</th>
                        <th class="px-4 py-3">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Filas se insertar√°n aqu√≠ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal para generar QR y c√≥digo -->
    <div id="generator-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-gray-800 rounded-2xl w-full max-w-4xl border border-gray-700 shadow-xl overflow-y-auto">
            <div class="flex justify-between items-center p-4 border-b border-gray-700 sticky top-0 bg-gray-800">
                <h2 class="text-xl font-bold text-white">Generar Activos para Referido</h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>

            <div class="p-6 grid md:grid-cols-2 gap-6">
                <!-- Vista Previa de la Tarjeta -->
                <div>
                    <h3 class="font-semibold text-lg text-white mb-2">Vista Previa de la Tarjeta</h3>
                    <div id="card-preview" class="bg-gray-700 rounded-2xl p-4 flex flex-col items-center text-center">
                        <div id="preview-emoji" class="text-3xl mb-2"></div>
                        <h4 id="preview-name" class="font-bold text-white text-md"></h4>
                        <p id="preview-specialty" class="text-sm text-gray-400 mb-2"></p>
                        <div id="preview-rating" class="flex items-center gap-2 mb-2"></div>
                        <a id="preview-whatsapp-btn" href="#" target="_blank" rel="noopener noreferrer" class="my-2 w-full bg-green-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center space-x-2 text-sm">
                            <span>WhatsApp</span>
                        </a>
                        <div id="preview-qr-container" class="w-[120px] h-[120px] mt-2 bg-white p-1 rounded-md">
                           <!-- QR se genera aqu√≠ -->
                        </div>
                    </div>
                </div>

                <!-- Generador y C√≥digo -->
                <div class="space-y-4">
                    <div>
                        <h3 class="font-semibold text-lg text-white mb-2">1. Descargar QR</h3>
                        <button id="download-qr-btn" class="w-full bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors">Descargar QR como PNG</button>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg text-white mb-2">2. Subir a GitHub</h3>
                        <p class="text-sm bg-gray-900 p-2 rounded-md font-mono" id="github-instruction"></p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg text-white mb-2">3. Copiar C√≥digo de Objeto</h3>
                        <div class="relative">
                            <pre id="code-output" class="generated-code bg-gray-900 p-4 rounded-lg text-xs text-yellow-300"></pre>
                            <button id="copy-code-btn" class="absolute top-2 right-2 bg-gray-700 text-gray-300 hover:bg-gray-600 text-xs px-2 py-1 rounded">Copiar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const sheetUrlInput = document.getElementById('sheet-url');
        const loadDataBtn = document.getElementById('load-data-btn');
        const referralsTableBody = document.querySelector('#referrals-table tbody');
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const modal = document.getElementById('generator-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        
        let currentData = null;

        const emojiMap = {
            'sucesiones': '‚öñÔ∏è', 'reparaciones': 'üîß', 'tr√°mites inmobiliarios': '‚úçÔ∏è', 'marketing inmobiliario': 'üìä',
            'odontolog√≠a': 'ü¶∑', 'impuestos': 'üßæ', 'instalaciones el√©ctricas': 'üí°', 'gastronom√≠a': 'üçΩÔ∏è',
            'seguros': 'üõ°Ô∏è', 'est√©tica': 'üíÜ‚Äç‚ôÄÔ∏è', 'veterinaria': 'üêæ', 'moda': 'üëó', 'peluquer√≠a': 'üíà',
            'farmacia': 'üíä', 'educaci√≥n': 'üìö', 'pasteler√≠a': 'üç∞', 'paisajismo': 'üå≥', 'tapicer√≠a': 'üõãÔ∏è',
            'psicolog√≠a': 'üß†', 'mec√°nica': 'üöó', 'libros': 'üìñ', 'mudanzas': 'üì¶', 'calzado': 'üëû',
            'danza': 'üíÉ', 'construcci√≥n': 'üî®', 'alimentos': 'üç´', 'carpinter√≠a': 'ü™ö',
            'default': '‚≠ê'
        };

        const getEmoji = (specialty) => {
            const lowerSpecialty = specialty.toLowerCase();
            for (const key in emojiMap) {
                if (lowerSpecialty.includes(key)) return emojiMap[key];
            }
            return emojiMap.default;
        };

        const sanitizePhoneNumber = (phone) => phone.replace(/[^0-9]/g, '');

        const displayError = (message) => {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        };

        const loadData = () => {
            const url = sheetUrlInput.value;
            if (!url) {
                displayError('Por favor, ingres√° la URL del Google Sheet.');
                return;
            }

            loadingDiv.classList.remove('hidden');
            errorDiv.classList.add('hidden');
            referralsTableBody.innerHTML = '';

            Papa.parse(url, {
                download: true,
                header: true,
                complete: (results) => {
                    loadingDiv.classList.add('hidden');
                    if (results.errors.length > 0) {
                        displayError('Error al leer el archivo CSV. Verific√° que la URL sea correcta y que la hoja est√© publicada como CSV.');
                        console.error(results.errors);
                        return;
                    }
                    currentData = results.data;
                    renderTable(currentData);
                },
                error: (err) => {
                    loadingDiv.classList.add('hidden');
                    displayError('No se pudo cargar el archivo. Verific√° la URL y la configuraci√≥n de CORS.');
                    console.error(err);
                }
            });
        };

        const renderTable = (data) => {
            referralsTableBody.innerHTML = '';
            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-700 hover:bg-gray-700/50';
                
                const address = row['Direcci√≥n (si tiene)'] || '';
                const barrioMatch = address.match(/,?\s*([a-zA-Z\s]+),\s*CABA/i);
                const barrio = barrioMatch ? barrioMatch[1].trim() : 'general';

                tr.innerHTML = `
                    <td class="px-4 py-3">${row['Marca temporal']}</td>
                    <td class="px-4 py-3 font-medium text-white">${row['Nombre y Apellido o Comercio']}</td>
                    <td class="px-4 py-3">${row['Especializaci√≥n']}</td>
                    <td class="px-4 py-3">${barrio}</td>
                    <td class="px-4 py-3">${row['Tel√©fono de WhatsApp']}</td>
                    <td class="px-4 py-3">
                        <button class="generate-btn bg-blue-600 text-white text-xs font-semibold py-1 px-3 rounded-md hover:bg-blue-700" data-index="${index}">
                            Generar
                        </button>
                    </td>
                `;
                referralsTableBody.appendChild(tr);
            });
        };
        
        const generateAssets = (index) => {
            const row = currentData[index];
            const name = row['Nombre y Apellido o Comercio'];
            const specialty = row['Especializaci√≥n'];
            const whatsapp = row['Tel√©fono de WhatsApp'];
            const rating = row['Puntuaci√≥n'] || '5';
            const referralsCount = (row['Referidos (clientes recientes que hayan usado su servicio o comprado)'] || '').split(',').length;

            const address = row['Direcci√≥n (si tiene)'] || '';
            const barrioMatch = address.match(/,?\s*([a-zA-Z\s]+),\s*CABA/i);
            const barrio = barrioMatch ? barrioMatch[1].trim().toLowerCase().replace(/\s+/g, '_') : 'general';

            const cleanPhone = sanitizePhoneNumber(whatsapp);
            const fileName = `${name.toLowerCase().replace(/\s+/g, '_')}.png`;

            // Update Preview Card
            document.getElementById('preview-emoji').textContent = getEmoji(specialty);
            document.getElementById('preview-name').textContent = name;
            document.getElementById('preview-specialty').textContent = specialty;
            const whatsappBtn = document.getElementById('preview-whatsapp-btn');
            whatsappBtn.href = `https://wa.me/${cleanPhone}`;
            
            const ratingContainer = document.getElementById('preview-rating');
            ratingContainer.innerHTML = '';
            for(let i=0; i<5; i++) {
                const star = document.createElement('span');
                star.textContent = '‚≠ê';
                star.className = i < parseInt(rating) ? '' : 'opacity-25';
                ratingContainer.appendChild(star);
            }
            const referralsLabel = document.createElement('span');
            referralsLabel.className = 'text-xs text-gray-500 ml-2';
            referralsLabel.textContent = `(${referralsCount} Referidos)`;
            ratingContainer.appendChild(referralsLabel);


            // Generate QR
            const qrContainer = document.getElementById('preview-qr-container');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: `https://wa.me/${cleanPhone}`,
                width: 120,
                height: 120,
            });

            // Set download button
            document.getElementById('download-qr-btn').onclick = () => {
                const canvas = qrContainer.querySelector('canvas');
                const link = document.createElement('a');
                link.download = fileName;
                link.href = canvas.toDataURL('image/png');
                link.click();
            };

            // Set GitHub instruction
            document.getElementById('github-instruction').textContent = `Subir a: referidos/${barrio}/${fileName}`;

            // Generate JS Object Code
            const codeOutput = document.getElementById('code-output');
            const referralObject = {
                name: name,
                specialty: specialty,
                whatsapp: `+${cleanPhone}`,
                qr: fileName,
                emoji: getEmoji(specialty),
                rating: parseInt(rating),
                referralsCount: referralsCount
            };
            codeOutput.textContent = `{\n${Object.entries(referralObject).map(([key, value]) => `  ${key}: ${JSON.stringify(value)}`).join(',\n')}\n},`;
            
            // Show modal
            modal.classList.remove('hidden');
        };

        // Event Listeners
        loadDataBtn.addEventListener('click', loadData);
        
        referralsTableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('generate-btn')) {
                const index = e.target.getAttribute('data-index');
                generateAssets(index);
            }
        });

        closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });

        document.addEventListener('click', e => {
            if (e.target.id === 'copy-code-btn') {
                const code = document.getElementById('code-output').textContent;
                navigator.clipboard.writeText(code).then(() => {
                    e.target.textContent = '¬°Copiado!';
                    setTimeout(() => { e.target.textContent = 'Copiar'; }, 2000);
                });
            }
        });

        // Initial load
        loadData();
    </script>
</body>
</html>
